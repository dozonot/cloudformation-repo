Description:
  This template deploys a VPC for WordPress.
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock          : !Ref VPCCIDR
      EnableDnsSupport   : true
      EnableDnsHostnames : true
      InstanceTenancy    : default
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId : !Ref InternetGateway
      VpcId             : !Ref VPC
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock           : !Ref PublicSubnet1CIDR
      MapPublicIpOnLaunch : true
      VpcId               : !Ref VPC
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock           : !Ref PublicSubnet2CIDR
      MapPublicIpOnLaunch : true
      VpcId               : !Ref VPC
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock           : !Ref PrivateSubnet1CIDR
      VpcId               : !Ref VPC
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock           : !Ref PrivateSubnet2CIDR
      VpcId               : !Ref VPC
  ElasticIP1: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-eip.html
    Type: AWS::EC2::EIP
    Properties:
      Domain: !Ref VPC
  ElasticIP2:
    Type: AWS::EC2::EIP
    Properties:
      Domain: !Ref VPC
  NatGateway1: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-natgateway.html
    Type: AWS::EC2::NatGateway
    DependsOn: InternetGateway
    Properties:
      AllocationId : 
        Fn::GetAtt:
          - ElasticIP1
          - AllocationId
      SubnetId     : !Ref PublicSubnet1
  NatGateway2:
    Type: AWS::EC2::NatGateway
    DependsOn: InternetGateway
    Properties:
      AllocationId : 
        Fn::GetAtt:
          - ElasticIP2
          - AllocationId
      SubnetId     : !Ref PublicSubnet2
  PublicRouteTable: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route-table.html
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId : !Ref VPC
  PublicRoute: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock : 0.0.0.0/0
      GatewayId            : !Ref InternetGateway
      RouteTableId         : !Ref PublicRouteTable
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId : !Ref VPC
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId : !Ref VPC
  PrivateRoute1: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock : 0.0.0.0/0
      NatGatewayId         : !Ref NatGateway1
      RouteTableId         : !Ref PrivateRouteTable1
  PrivateRoute2: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-route.html
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock : 0.0.0.0/0
      NatGatewayId         : !Ref NatGateway2
      RouteTableId         : !Ref PrivateRouteTable2
  PublicSubnet1RouteTableAssociation: # https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-subnet-route-table-assoc.html
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

Parameters:
  VPCCIDR:
    Type: String
  PublicSubnet1CIDR:
    Type: String
  PublicSubnet2CIDR:
    Type: String
  PrivateSubnet1CIDR:
    Type: String
  PrivateSubnet2CIDR:
    Type: String

Outputs:
  WordPressVPC:
    Value: !Ref VPC
  WordPressPrivateSubnet1:
    Value: !Ref PrivateSubnet1
  WordPressPrivateSubnet2:
    Value: !Ref PrivateSubnet2
  WordPressPublicSubnet1:
    Value: !Ref PublicSubnet1
  WordPressPublicSubnet2:
    Value: !Ref PublicSubnet2
